# Account Provisioning System

**Multi-Admin System with Comprehensive Account Creation**

## Overview

This system provides a comprehensive account provisioning solution that combines user creation, subscription tier assignment, and invitation email delivery with proper admin access controls and audit logging.

## System Architecture

### Admin Tiers

1. **Promo Admin** (`100ktrackeradmin`)
   - Access to promotional signup dashboard
   - Can manage Operandi Challenge applications
   - Can create accounts from promo signups

2. **General Admin** (`100ktrackeradmin-general`)
   - Full access to account provisioning system
   - Can create accounts with any subscription tier
   - Access to audit logs and user management

### Database Enhancements

#### New Tables

- `provisioning_audit` - Logs all provisioning attempts with step-by-step tracking
- `promo_signups` - Enhanced with better status tracking

#### New Functions

- `createGeneralAdminUser()` - Creates the general admin account
- `isGeneralAdmin()` - Validates general admin permissions
- `runProvisioningTransaction()` - Executes multi-step operations with rollback
- `logProvisioningAttempt()` - Records audit trail for all provisioning activities

#### Subscription Tiers

- **Free**: Basic tracking features
- **Platinum**: Premium features with priority support
- **Operandi**: Special tier for Operandi Challenge participants

## API Endpoints

### General Admin Routes (`/api/admin/`)

#### `POST /provision-account`

**Comprehensive account provisioning with step-by-step validation**

**Headers:**

```
Authorization: Bearer <general-admin-jwt-token>
Content-Type: application/json
```

**Request Body:**

```json
{
  "email": "user@example.com",
  "fullName": "John Doe",
  "subscriptionTier": "operandi",
  "temporaryPassword": "optional-custom-password",
  "sendEmail": true,
  "promoSignupId": "optional-promo-id"
}
```

**Response (Success):**

```json
{
  "success": true,
  "message": "Account provisioned successfully",
  "account": {
    "userId": 123,
    "username": "john.doe",
    "email": "user@example.com",
    "temporaryPassword": "AutoGenerated123!"
  },
  "subscription": {
    "tier": "operandi",
    "status": "active",
    "features": ["operandi_challenge", "premium_features", "exclusive_access"]
  },
  "email": {
    "sent": true,
    "messageId": "email-id",
    "previewUrl": "https://ethereal.email/message/xxx"
  },
  "steps": {
    "accountCreated": true,
    "subscriptionAssigned": true,
    "emailSent": true,
    "promoUpdated": false
  },
  "timestamp": "2025-01-01T12:00:00Z"
}
```

**Features:**

- ‚úÖ **Transaction Support**: All operations wrapped in rollback-capable transactions
- ‚úÖ **Email Retry Logic**: 2-attempt retry with failure rollback
- ‚úÖ **Step-by-Step Validation**: Each step validated before proceeding
- ‚úÖ **Comprehensive Audit Logging**: All attempts logged with admin user tracking
- ‚úÖ **Secure Password Generation**: Auto-generated secure passwords with complexity requirements
- ‚úÖ **Production-Ready Email URLs**: Always uses production URLs in email templates

#### `POST /resend-invitation`

**Resend invitation email for existing users**

```json
{
  "username": "john.doe",
  "email": "user@example.com"
}
```

### Enhanced Promo Routes (`/api/promo/`)

#### `POST /admin/signups/:id/create-account`

**Create account from promo signup using provisioning system**

**Features:**

- üîÑ **Automatic Provisioning Integration**: Uses new provisioning API automatically
- üéØ **Operandi Tier Assignment**: Automatically assigns 'operandi' subscription tier
- üìß **Invitation Email**: Sends welcome email with login credentials
- üõ°Ô∏è **Fallback System**: Falls back to manual creation if provisioning fails
- üìä **Enhanced Response**: Returns full provisioning details including steps

**Response Example:**

```json
{
  "success": true,
  "message": "Operandi Challenge account created successfully",
  "account": {
    "userId": 123,
    "username": "applicant",
    "email": "applicant@example.com",
    "temporaryPassword": "Generated123!"
  },
  "subscription": {
    "tier": "operandi",
    "status": "active",
    "features": ["operandi_challenge", "premium_features", "exclusive_access"]
  },
  "email": {
    "sent": true,
    "messageId": "msg-id"
  },
  "signup": {
    "id": 1,
    "status": "approved",
    "fullName": "John Doe",
    "businessName": "John's Watches"
  },
  "provisioning": {
    "steps": {
      "accountCreated": true,
      "subscriptionAssigned": true,
      "emailSent": true,
      "promoUpdated": true
    },
    "timestamp": "2025-01-01T12:00:00Z"
  }
}
```

## Email Templates

### Invitation Email Features

- üé® **Professional Design**: Dark theme matching 100K Tracker branding
- üîê **Secure Credentials Display**: Clear presentation of login information
- ‚ö†Ô∏è **Password Security Warning**: Alerts for temporary passwords
- üìã **Getting Started Guide**: Step-by-step onboarding instructions
- ‚ú® **Feature Overview**: Highlights available features
- üåê **Production URLs**: Always links to live site, never localhost

### Template Variables

- Dynamic base URL based on NODE_ENV
- Temporary password indicators
- Feature lists based on subscription tier
- Personalized content

## Authentication & Security

### JWT Token Structure

```javascript
// General Admin Token
{
  "username": "100ktrackeradmin-general",
  "role": "general_admin",
  "exp": timestamp
}

// Promo Admin Token
{
  "username": "100ktrackeradmin",
  "role": "promo_admin",
  "exp": timestamp
}
```

### Middleware Functions

- `authenticateGeneralAdmin()` - Validates general admin access
- `authenticatePromoAdmin()` - Validates promo admin access
- Username-specific validation for admin accounts

## Audit & Logging

### Provisioning Audit Table

```sql
CREATE TABLE provisioning_audit (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT NOT NULL,
    full_name TEXT,
    subscription_tier TEXT,
    admin_user TEXT NOT NULL,
    step_completed TEXT NOT NULL,
    success INTEGER NOT NULL,
    error_message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### Logged Events

- `started` - Provisioning attempt initiated
- `validation` - Input validation step
- `account_created` - User account creation
- `email_sent` - Invitation email delivery
- `completed` - Full provisioning success
- `failed` - Provisioning failure
- `rollback` - Transaction rollback performed
- `rollback_failed` - Critical error during rollback

## Error Handling & Rollback

### Rollback Scenarios

1. **Email Delivery Failure**: Account creation is rolled back if email cannot be sent
2. **Subscription Assignment Failure**: User account is deleted if subscription fails
3. **Validation Errors**: Prevent any account creation attempts

### Error Response Examples

**Validation Error:**

```json
{
  "error": "Validation failed",
  "message": "Email and fullName are required"
}
```

**Rollback Performed:**

```json
{
  "error": "Email delivery failed",
  "message": "Account creation was rolled back due to email delivery failure",
  "emailError": "SMTP connection failed",
  "rollbackPerformed": true,
  "steps": {
    "accountCreated": true,
    "subscriptionAssigned": true,
    "emailSent": false,
    "promoUpdated": false
  }
}
```

**Critical Error:**

```json
{
  "error": "Critical error during rollback",
  "message": "Account was created but email failed and rollback failed. Manual intervention required.",
  "account": { "userId": 123, "username": "user" },
  "manualAction": "Delete user user manually and retry provisioning"
}
```

## Production Deployment

### Environment Variables

```bash
NODE_ENV=production
APP_URL=https://100ktracker.com
JWT_SECRET=your-secure-secret
EMAIL_SERVICE=gmail
EMAIL_USER=onboarding@100ktracker.com
EMAIL_PASSWORD=app-specific-password
```

### URL Configuration

- **Development**: Uses `http://localhost:5173` for app links
- **Production**: Uses `https://100ktracker.com` for all email links
- **Email Links**: Always production URLs regardless of environment

## Testing

### Test Scripts

- `test-provisioning.js` - Comprehensive provisioning system test
- Validates admin authentication
- Tests account creation workflow
- Verifies error handling

### Manual Testing

1. Start backend server: `npm start`
2. Test provisioning: `node test-provisioning.js`
3. Check promo signup creation in admin dashboard
4. Verify email delivery (Ethereal Email for testing)

## Integration Points

### Frontend Integration

- Promo admin dashboard: Button to create accounts from signups
- General admin dashboard: Full provisioning interface
- Error handling: Displays detailed provisioning results

### External Services

- **Email Service**: Nodemailer with Gmail/Ethereal fallback
- **Database**: SQLite with transaction support
- **Authentication**: JWT-based admin verification

## Future Enhancements

### Phase 5: General Admin Dashboard

- User management interface
- Bulk account operations
- Advanced filtering and search
- Provisioning history and analytics

### Potential Features

- Bulk CSV import for account creation
- Custom email templates per subscription tier
- User invitation status tracking
- Advanced subscription management

## Troubleshooting

### Common Issues

**Server Connection Errors:**

- Ensure backend is running on port 3001
- Check JWT_SECRET is configured
- Verify admin users exist in database

**Email Delivery Failures:**

- Check email service configuration
- Verify SMTP credentials
- Review Ethereal Email for test messages

**Database Errors:**

- Ensure SQLite database has write permissions
- Check for constraint violations (duplicate emails)
- Review database initialization logs

### Debug Commands

```bash
# Check environment
curl http://localhost:3001/api/env-check

# Check database status
curl http://localhost:3001/api/db-status

# Health check
curl http://localhost:3001/health
```

## Security Considerations

- Admin accounts use strong, unique passwords
- JWT tokens have appropriate expiration times
- All provisioning attempts are logged for audit
- Database transactions prevent partial account creation
- Email links always point to production for security

---

**Status: ‚úÖ Phases 1-4 Complete**

- ‚úÖ Database enhancements with admin users and audit logging
- ‚úÖ Authentication middleware for multi-admin system
- ‚úÖ Comprehensive provisioning API with rollback support
- ‚úÖ Enhanced promo integration with automatic provisioning

**Next: Phase 5 - General Admin Dashboard UI**
